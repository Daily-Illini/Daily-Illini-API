{% extends 'base.html' %}

{% block title %}
API Query
{% endblock %}

{% block content %}
<script>
function setMethod(item) {
    document.getElementById('submitRequest').innerHTML = item.innerHTML;
}

async function sendRequest(form, event) {
    event.preventDefault();
    const fields = new FormData(form);
    const csrfToken = fields.get('_csrf_token');
    const requestPath = fields.get('requestPath');
    const requestBody = `_csrf_token=${csrfToken}&${fields.get('requestBody')}`;
    const method = document.getElementById('submitRequest').innerHTML;

    const response = await fetch(requestPath, {
        method,
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: method === "POST" ? requestBody : null,
    });
    document.getElementById('response').value = await response.text();

    // Save history
    saveRequestPathHistory(requestPath);
    saveRequestBodyHistory(fields.get('requestBody'));
}

// Manage request path and request body history using localStorage
const pathHistoryKey = 'requestPathHistory';
const bodyHistoryKey = 'requestBodyHistory';

function loadHistory(key) {
    return JSON.parse(localStorage.getItem(key)) || [];
}

function saveHistory(key, value) {
    const history = loadHistory(key);
    if (!history.includes(value) && value.trim() !== "") {
        history.push(value);
        localStorage.setItem(key, JSON.stringify(history));
    }
}

function saveRequestPathHistory(path) {
    saveHistory(pathHistoryKey, path);
}

function saveRequestBodyHistory(body) {
    saveHistory(bodyHistoryKey, body);
}

function showHistoryDropdown(inputElement, historyList, history) {
    historyList.innerHTML = ''; // Clear current dropdown

    history.forEach(function (item) {
        const listItem = document.createElement('li');
        listItem.textContent = item;
        listItem.classList.add('dropdown-item');
        listItem.addEventListener('click', function () {
            inputElement.value = item;  // Set input value to selected history item
            historyList.style.display = 'none';
        });
        historyList.appendChild(listItem);
    });

    if (history.length > 0) {
        historyList.style.display = 'block';
    } else {
        historyList.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const requestPathInput = document.getElementById('requestPath');
    const requestBodyInput = document.getElementById('requestBody');

    const requestPathHistoryList = document.createElement('ul');
    requestPathHistoryList.classList.add('dropdown-menu');
    requestPathInput.parentNode.appendChild(requestPathHistoryList);

    const requestBodyHistoryList = document.createElement('ul');
    requestBodyHistoryList.classList.add('dropdown-menu');
    requestBodyInput.parentNode.appendChild(requestBodyHistoryList);

    // Show request path history on input focus
    requestPathInput.addEventListener('focus', function () {
        const history = loadHistory(pathHistoryKey);
        showHistoryDropdown(requestPathInput, requestPathHistoryList, history);
    });

    // Show request body history on input focus
    requestBodyInput.addEventListener('focus', function () {
        const history = loadHistory(bodyHistoryKey);
        showHistoryDropdown(requestBodyInput, requestBodyHistoryList, history);
    });

    // Hide history dropdowns on clicking outside
    document.addEventListener('click', function (e) {
        if (!requestPathHistoryList.contains(e.target) && e.target !== requestPathInput) {
            requestPathHistoryList.style.display = 'none';
        }
        if (!requestBodyHistoryList.contains(e.target) && e.target !== requestBodyInput) {
            requestBodyHistoryList.style.display = 'none';
        }
    });
});
</script>

<div class="d-flex justify-content-center">
    <form class="card w-75 m-4 p-3" onsubmit="sendRequest(this, event)">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="requestPath" class="form-label">Request Path</label>
            <div class="d-flex">
                <input name="requestPath" type="text" class="form-control" id="requestPath">
                <ul id="request-path-history" class="dropdown-menu"></ul>
                <div class="btn-group ms-3">
                    <button type="submit" class="btn btn-primary" id="submitRequest">GET</button>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <button type="button" class="dropdown-item" onclick="setMethod(this)">GET</button>
                        <button type="button" class="dropdown-item" onclick="setMethod(this)">POST</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label for="requestBody" class="form-label">Request Body</label>
            <textarea name="requestBody" class="form-control font-monospace" id="requestBody" rows="4" placeholder="key1=value1&key2=value2"></textarea>
            <ul id="request-body-history" class="dropdown-menu"></ul>
        </div>
        <div class="mb-3">
            <label for="response" class="form-label">Response</label>
            <textarea class="form-control font-monospace" id="response" rows="8"></textarea>
        </div>
    </form>
</div>
{% endblock %}
